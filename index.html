<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Surovi Agro Industries - National Stock Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #3498db;
            --success-color: #27ae60;
            --warning-color: #f39c12;
            --danger-color: #e74c3c;
        }
        
        body {
            background-color: #f8f9fa;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        .dashboard-header {
            background: linear-gradient(135deg, var(--primary-color), #34495e);
            color: white;
            padding: 20px 0;
            margin-bottom: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .card {
            border: none;
            border-radius: 10px;
            box-shadow: 0 2px 15px rgba(0,0,0,0.08);
            margin-bottom: 20px;
            transition: transform 0.3s ease;
        }
        
        .card:hover {
            transform: translateY(-2px);
        }
        
        .card-header {
            background-color: white;
            border-bottom: 2px solid var(--secondary-color);
            font-weight: 600;
        }
        
        .btn-primary {
            background-color: var(--secondary-color);
            border-color: var(--secondary-color);
            padding: 10px 25px;
        }
        
        .btn-primary:hover {
            background-color: #2980b9;
            border-color: #2980b9;
        }
        
        .table th {
            background-color: #f8f9fa;
            border-top: none;
            font-weight: 600;
            color: var(--primary-color);
        }
        
        .progress-bar {
            background-color: var(--secondary-color);
        }
        
        .depot-indicator {
            width: 15px;
            height: 15px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
        }
        
        .file-upload-area {
            border: 2px dashed #dee2e6;
            border-radius: 10px;
            padding: 40px;
            text-align: center;
            background-color: white;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .file-upload-area:hover {
            border-color: var(--secondary-color);
            background-color: #f8f9fa;
        }
        
        .sheet-tab {
            padding: 10px 20px;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
        }
        
        .sheet-tab.active {
            border-bottom-color: var(--secondary-color);
            color: var(--secondary-color);
            font-weight: 600;
        }
        
        .stock-value {
            font-weight: 600;
        }
        
        .low-stock {
            color: var(--danger-color);
            background-color: rgba(231, 76, 60, 0.1);
            padding: 2px 8px;
            border-radius: 4px;
        }
        
        .medium-stock {
            color: var(--warning-color);
            background-color: rgba(243, 156, 18, 0.1);
            padding: 2px 8px;
            border-radius: 4px;
        }
        
        .high-stock {
            color: var(--success-color);
            background-color: rgba(39, 174, 96, 0.1);
            padding: 2px 8px;
            border-radius: 4px;
        }
        
        .dashboard-card {
            border-left: 4px solid var(--secondary-color);
        }
        
        .stat-card {
            text-align: center;
            padding: 20px;
        }
        
        .stat-icon {
            font-size: 2.5em;
            color: var(--secondary-color);
            margin-bottom: 15px;
        }
        
        .stat-value {
            font-size: 2em;
            font-weight: 700;
            color: var(--primary-color);
        }
        
        .stat-label {
            color: #6c757d;
            font-size: 0.9em;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .search-box {
            max-width: 400px;
        }
        
        @media (max-width: 768px) {
            .dashboard-header h1 {
                font-size: 1.5em;
            }
            
            .stat-card {
                padding: 15px;
            }
            
            .stat-value {
                font-size: 1.5em;
            }
            
            .table-responsive {
                font-size: 0.9em;
            }
        }
        
        .product-row:hover {
            background-color: #f8f9fa !important;
        }
        
        .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 5px;
        }
        
        .status-low { background-color: var(--danger-color); }
        .status-medium { background-color: var(--warning-color); }
        .status-high { background-color: var(--success-color); }
    </style>
</head>
<body>
    <div class="dashboard-header">
        <div class="container">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <h1><i class="fas fa-warehouse me-2"></i>Surovi Agro Industries Ltd.</h1>
                    <p class="mb-0">National Stock Dashboard</p>
                </div>
                <div class="col-md-4 text-md-end">
                    <div class="input-group search-box">
                        <input type="text" class="form-control" placeholder="Search products..." id="searchInput">
                        <button class="btn btn-outline-light" type="button" onclick="searchProducts()">
                            <i class="fas fa-search"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="container">
        <!-- File Upload Section -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <i class="fas fa-file-upload me-2"></i>Upload Excel File
                    </div>
                    <div class="card-body">
                        <div id="fileUploadArea" class="file-upload-area">
                            <i class="fas fa-cloud-upload-alt fa-3x mb-3 text-secondary"></i>
                            <h5>Drag & Drop your Excel file here</h5>
                            <p class="text-muted">or click to browse (supports .xlsx, .xls)</p>
                            <input type="file" id="excelFile" accept=".xlsx,.xls" class="d-none">
                            <button class="btn btn-primary mt-3" onclick="document.getElementById('excelFile').click()">
                                <i class="fas fa-folder-open me-2"></i>Browse Files
                            </button>
                        </div>
                        <div id="fileInfo" class="mt-3 d-none">
                            <div class="alert alert-success">
                                <i class="fas fa-check-circle me-2"></i>
                                <span id="fileName"></span> loaded successfully
                                <span id="sheetCount" class="float-end"></span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Dashboard Stats -->
        <div id="dashboardStats" class="row d-none">
            <div class="col-md-3">
                <div class="card stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-boxes"></i>
                    </div>
                    <div class="stat-value" id="totalProducts">0</div>
                    <div class="stat-label">Total Products</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-calculator"></i>
                    </div>
                    <div class="stat-value" id="totalStock">0</div>
                    <div class="stat-label">Total Stock (Units)</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-exclamation-triangle"></i>
                    </div>
                    <div class="stat-value" id="lowStock">0</div>
                    <div class="stat-label">Low Stock Items</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-calendar-alt"></i>
                    </div>
                    <div class="stat-value" id="reportDate">-</div>
                    <div class="stat-label">Report Date</div>
                </div>
            </div>
        </div>

        <!-- Sheet Tabs -->
        <div id="sheetTabsContainer" class="row d-none">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <i class="fas fa-calendar me-2"></i>Select Date Sheet
                    </div>
                    <div class="card-body">
                        <div id="sheetTabs" class="d-flex flex-wrap gap-2">
                            <!-- Tabs will be generated here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Low Stock Alert -->
        <div id="lowStockAlert" class="row d-none">
            <div class="col-12">
                <div class="card border-warning">
                    <div class="card-header bg-warning text-white">
                        <i class="fas fa-exclamation-triangle me-2"></i>Low Stock Alerts
                    </div>
                    <div class="card-body">
                        <div id="lowStockList">
                            <!-- Low stock items will be listed here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Product Stock Table -->
        <div id="productStockSection" class="row d-none">
            <div class="col-12">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <div>
                            <i class="fas fa-box me-2"></i>Product Stock Summary
                            <span class="badge bg-secondary ms-2" id="productCount">0 products</span>
                        </div>
                        <div class="d-flex gap-2">
                            <button class="btn btn-success btn-sm" onclick="exportToExcel()" id="exportBtn">
                                <i class="fas fa-file-excel me-1"></i> Export
                            </button>
                            <div class="dropdown">
                                <button class="btn btn-outline-secondary btn-sm dropdown-toggle" type="button" 
                                        data-bs-toggle="dropdown" aria-expanded="false">
                                    <i class="fas fa-filter me-1"></i>Filter
                                </button>
                                <ul class="dropdown-menu">
                                    <li><a class="dropdown-item" href="#" onclick="filterStock('all')">All Products</a></li>
                                    <li><a class="dropdown-item" href="#" onclick="filterStock('low')">Low Stock Only</a></li>
                                    <li><hr class="dropdown-divider"></li>
                                    <li><a class="dropdown-item" href="#" onclick="filterStock('category', 'Herbicides')">Herbicides</a></li>
                                    <li><a class="dropdown-item" href="#" onclick="filterStock('category', 'Fungicides')">Fungicides</a></li>
                                    <li><a class="dropdown-item" href="#" onclick="filterStock('category', 'Insecticides')">Insecticides</a></li>
                                </ul>
                            </div>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover" id="stockTable">
                                <thead>
                                    <tr>
                                        <th>#</th>
                                        <th>Product Name</th>
                                        <th>Portfolio</th>
                                        <th>Dhaka</th>
                                        <th>Jhenaidah</th>
                                        <th>Bogra</th>
                                        <th>Rangpur</th>
                                        <th>Chattagram</th>
                                        <th>Total Units</th>
                                        <th>Cartons</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="stockTableBody">
                                    <!-- Data will be loaded here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Depot-wise Analysis -->
        <div id="depotAnalysisSection" class="row d-none">
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header">
                        <i class="fas fa-chart-bar me-2"></i>Depot-wise Stock Distribution
                    </div>
                    <div class="card-body">
                        <canvas id="depotChart"></canvas>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card">
                    <div class="card-header">
                        <i class="fas fa-map-marker-alt me-2"></i>Depot Stock Summary
                    </div>
                    <div class="card-body">
                        <div id="depotSummary">
                            <!-- Depot summary will be loaded here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal for Product Details -->
    <div class="modal fade" id="productModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="productModalTitle">Product Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="productModalBody">
                    <!-- Product details will be loaded here -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
    <script>
        // Global variables
        let excelData = null;
        let currentSheetIndex = 0;
        let currentData = null;
        let depotChart = null;
        let filteredProducts = null;

        // DOM elements
        const fileInput = document.getElementById('excelFile');
        const fileUploadArea = document.getElementById('fileUploadArea');
        const fileInfo = document.getElementById('fileInfo');
        const fileName = document.getElementById('fileName');
        const sheetCount = document.getElementById('sheetCount');
        const dashboardStats = document.getElementById('dashboardStats');
        const sheetTabsContainer = document.getElementById('sheetTabsContainer');
        const productStockSection = document.getElementById('productStockSection');
        const depotAnalysisSection = document.getElementById('depotAnalysisSection');
        const lowStockAlert = document.getElementById('lowStockAlert');

        // File upload event listeners
        fileInput.addEventListener('change', handleFileUpload);
        
        // Drag and drop functionality
        fileUploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            fileUploadArea.style.borderColor = '#3498db';
            fileUploadArea.style.backgroundColor = '#f0f8ff';
        });
        
        fileUploadArea.addEventListener('dragleave', () => {
            fileUploadArea.style.borderColor = '#dee2e6';
            fileUploadArea.style.backgroundColor = 'white';
        });
        
        fileUploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            fileUploadArea.style.borderColor = '#dee2e6';
            fileUploadArea.style.backgroundColor = 'white';
            
            if (e.dataTransfer.files.length) {
                fileInput.files = e.dataTransfer.files;
                handleFileUpload();
            }
        });

        async function handleFileUpload() {
            if (!fileInput.files.length) return;
            
            const file = fileInput.files[0];
            
            // Show loading state
            fileUploadArea.innerHTML = `
                <div class="spinner-border text-primary mb-3" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <h5>Processing ${file.name}</h5>
                <p class="text-muted">Please wait...</p>
            `;
            
            try {
                const data = await readExcelFile(file);
                excelData = data;
                
                // Process each sheet
                data.sheets.forEach(sheet => {
                    sheet.parsedData = parseSheetData(sheet.data);
                    sheet.parsedData.sheetName = sheet.name;
                });
                
                // Show file info
                fileName.textContent = file.name;
                sheetCount.textContent = `${data.sheets.length} date sheet(s)`;
                fileInfo.classList.remove('d-none');
                
                // Reset upload area
                fileUploadArea.innerHTML = `
                    <i class="fas fa-cloud-upload-alt fa-3x mb-3 text-secondary"></i>
                    <h5>Drag & Drop your Excel file here</h5>
                    <p class="text-muted">or click to browse (supports .xlsx, .xls)</p>
                    <button class="btn btn-primary mt-3" onclick="document.getElementById('excelFile').click()">
                        <i class="fas fa-folder-open me-2"></i>Browse Files
                    </button>
                `;
                
                // Initialize dashboard with first sheet
                initializeDashboard(data.sheets[0].parsedData);
                createSheetTabs(data.sheets);
                
            } catch (error) {
                console.error('Error reading Excel file:', error);
                alert('Error reading Excel file: ' + error.message);
                
                // Reset upload area
                fileUploadArea.innerHTML = `
                    <i class="fas fa-cloud-upload-alt fa-3x mb-3 text-secondary"></i>
                    <h5>Drag & Drop your Excel file here</h5>
                    <p class="text-muted">or click to browse (supports .xlsx, .xls)</p>
                    <button class="btn btn-primary mt-3" onclick="document.getElementById('excelFile').click()">
                        <i class="fas fa-folder-open me-2"></i>Browse Files
                    </button>
                `;
            }
        }

        function readExcelFile(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    try {
                        const data = e.target.result;
                        const workbook = XLSX.read(data, { type: 'binary' });
                        
                        const sheets = workbook.SheetNames.map(sheetName => {
                            const worksheet = workbook.Sheets[sheetName];
                            const sheetData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                            
                            return {
                                name: sheetName,
                                date: sheetName,
                                data: sheetData
                            };
                        });
                        
                        resolve({ sheets, workbook });
                    } catch (error) {
                        reject(error);
                    }
                };
                
                reader.onerror = reject;
                reader.readAsBinaryString(file);
            });
        }

        function parseSheetData(sheetData) {
            console.log("Parsing sheet data...");
            
            const products = [];
            const depots = ['Dhaka', 'Jhenaidah', 'Bogra', 'Rangpur', 'Chattagram'];
            
            // Skip header rows (first 6 rows are headers)
            for (let i = 6; i < sheetData.length; i++) {
                const row = sheetData[i];
                
                // Check if this is a product row (has product name in column B)
                if (row && row[1] && typeof row[1] === 'string' && row[1].trim()) {
                    const productName = row[1].toString().trim();
                    
                    // Skip if it's a header or empty row
                    if (productName === 'Product Name' || productName === 'PRODUCT NAME' || productName === '') {
                        continue;
                    }
                    
                    const product = {
                        name: productName,
                        packSize: row[2] ? row[2].toString().trim() : '',
                        portfolio: row[0] ? row[0].toString().trim() : '',
                        depots: {},
                        cartonDepots: {},  // For carton-wise data
                        unitPerCarton: 0,
                        totalFG: 0,
                        fgLtrKg: 0,
                        rmBulk: 0,
                        grandTotal: 0,
                        factoryFG: 0,
                        factoryFGCartons: 0,
                        totalCartons: 0,
                        rowIndex: i + 1  // Store original row number for debugging
                    };
                    
                    try {
                        // Extract depot values (Unit wise - columns E, F, G, H, I)
                        // E=Dhaka, F=Jhenaidah, G=Bogra, H=Rangpur, I=Chattagram
                        const depotColumns = [4, 5, 6, 7, 8]; // E, F, G, H, I (0-based)
                        depots.forEach((depot, index) => {
                            const value = row[depotColumns[index]];
                            product.depots[depot] = parseNumericValue(value);
                        });
                        
                        // Extract factory FG (column J)
                        product.factoryFG = parseNumericValue(row[9]);
                        
                        // Calculate unit total (sum of all depots + factory FG)
                        product.totalUnits = Object.values(product.depots).reduce((a, b) => a + b, 0) + product.factoryFG;
                        
                        // Extract carton-wise data (right side)
                        // U=Unit per Carton (index 20), V=Dhaka, W=Jhenaidah, X=Bogra, Y=Rangpur, Z=Chattagram
                        const cartonStartCol = 20; // Column U
                        
                        // Unit per Carton (column U)
                        product.unitPerCarton = parseNumericValue(row[cartonStartCol]) || 1;
                        
                        // Carton depot values (columns V to Z)
                        for (let j = 0; j < 5; j++) {
                            const cartonValue = row[cartonStartCol + 1 + j]; // V, W, X, Y, Z
                            product.cartonDepots[depots[j]] = parseNumericValue(cartonValue);
                        }
                        
                        // Factory FG in cartons (column AA)
                        product.factoryFGCartons = parseNumericValue(row[cartonStartCol + 6]);
                        
                        // Total cartons (column AB)
                        product.totalCartons = parseNumericValue(row[cartonStartCol + 7]);
                        
                        // Calculate total cartons if not present
                        if (!product.totalCartons) {
                            product.totalCartons = Object.values(product.cartonDepots).reduce((a, b) => a + b, 0) + 
                                                  product.factoryFGCartons;
                        }
                        
                        // Determine stock status based on total units
                        product.status = getStockStatus(product.totalUnits);
                        
                        // Add to products array
                        products.push(product);
                        
                    } catch (error) {
                        console.error(`Error parsing row ${i + 1} for product ${productName}:`, error);
                    }
                }
            }
            
            console.log(`Parsed ${products.length} products`);
            
            // Calculate totals
            const totalUnits = products.reduce((sum, p) => sum + p.totalUnits, 0);
            const totalCartons = products.reduce((sum, p) => sum + (p.totalCartons || 0), 0);
            
            return {
                products,
                depots,
                totalProducts: products.length,
                totalUnits,
                totalCartons,
                sheetName: "Current Sheet"
            };
        }

        function parseNumericValue(value) {
            if (value === undefined || value === null || value === '') {
                return 0;
            }
            
            // If it's a string that starts with '=', try to evaluate it
            if (typeof value === 'string' && value.startsWith('=')) {
                try {
                    // Remove the '=' and any $ signs
                    const formula = value.substring(1).replace(/\$/g, '');
                    // Simple evaluation - only works for basic arithmetic
                    const cleanFormula = formula.replace(/[^0-9+\-*/.()]/g, '');
                    if (cleanFormula) {
                        return eval(cleanFormula);
                    }
                } catch (e) {
                    console.warn('Could not evaluate formula:', value, e);
                }
            }
            
            // Try to parse as a number
            const num = parseFloat(value);
            return isNaN(num) ? 0 : num;
        }

        function getStockStatus(total) {
            if (total <= 50) return 'low';
            if (total <= 200) return 'medium';
            return 'high';
        }

        function formatNumber(num) {
            if (num === undefined || num === null) return '0';
            return num.toLocaleString('en-IN', {
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            });
        }

        function initializeDashboard(sheetData) {
            currentData = sheetData;
            filteredProducts = [...sheetData.products];
            
            // Show dashboard sections
            dashboardStats.classList.remove('d-none');
            sheetTabsContainer.classList.remove('d-none');
            productStockSection.classList.remove('d-none');
            depotAnalysisSection.classList.remove('d-none');
            
            // Update dashboard stats
            updateDashboardStats(sheetData);
            
            // Populate product table
            populateProductTable(filteredProducts);
            
            // Create depot chart
            createDepotChart(sheetData);
            
            // Check for low stock
            checkLowStock(sheetData.products);
        }

        function updateDashboardStats(data) {
            document.getElementById('totalProducts').textContent = data.totalProducts;
            document.getElementById('totalStock').textContent = formatNumber(data.totalUnits);
            
            const lowStockCount = data.products.filter(p => p.status === 'low').length;
            document.getElementById('lowStock').textContent = lowStockCount;
            
            // Update report date (extract from sheet name)
            let reportDate = 'N/A';
            if (data.sheetName) {
                const dateMatch = data.sheetName.match(/\d{2}\.\d{2}\.\d{4}/);
                reportDate = dateMatch ? dateMatch[0] : data.sheetName;
            }
            document.getElementById('reportDate').textContent = reportDate;
        }

        function createSheetTabs(sheets) {
            const tabsContainer = document.getElementById('sheetTabs');
            tabsContainer.innerHTML = '';
            
            sheets.forEach((sheet, index) => {
                const tab = document.createElement('div');
                tab.className = `sheet-tab ${index === 0 ? 'active' : ''}`;
                tab.textContent = sheet.date;
                tab.onclick = () => switchSheet(index);
                tabsContainer.appendChild(tab);
            });
        }

        function switchSheet(index) {
            currentSheetIndex = index;
            const sheet = excelData.sheets[index];
            
            // Update active tab
            document.querySelectorAll('.sheet-tab').forEach((tab, i) => {
                tab.classList.toggle('active', i === index);
            });
            
            // Reinitialize dashboard with new sheet
            initializeDashboard(sheet.parsedData);
        }

        function populateProductTable(products) {
            const tbody = document.getElementById('stockTableBody');
            const productCount = document.getElementById('productCount');
            
            tbody.innerHTML = '';
            productCount.textContent = `${products.length} products`;
            
            if (products.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="12" class="text-center text-muted py-4">
                            <i class="fas fa-box-open fa-2x mb-3"></i>
                            <p>No products found</p>
                        </td>
                    </tr>
                `;
                return;
            }
            
            products.forEach((product, index) => {
                const row = document.createElement('tr');
                row.className = 'product-row';
                
                // Status indicator
                let statusBadge = '';
                let statusClass = '';
                switch(product.status) {
                    case 'low':
                        statusBadge = '<span class="low-stock"><i class="fas fa-exclamation-circle me-1"></i>Low</span>';
                        row.classList.add('table-danger');
                        break;
                    case 'medium':
                        statusBadge = '<span class="medium-stock"><i class="fas fa-info-circle me-1"></i>Medium</span>';
                        row.classList.add('table-warning');
                        break;
                    case 'high':
                        statusBadge = '<span class="high-stock"><i class="fas fa-check-circle me-1"></i>High</span>';
                        row.classList.add('table-success');
                        break;
                }
                
                row.innerHTML = `
                    <td>${index + 1}</td>
                    <td>
                        <strong>${product.name}</strong>
                        ${product.packSize ? `<br><small class="text-muted">${product.packSize}</small>` : ''}
                    </td>
                    <td>${product.portfolio || '-'}</td>
                    <td class="text-end stock-value">${formatNumber(product.depots.Dhaka)}</td>
                    <td class="text-end stock-value">${formatNumber(product.depots.Jhenaidah)}</td>
                    <td class="text-end stock-value">${formatNumber(product.depots.Bogra)}</td>
                    <td class="text-end stock-value">${formatNumber(product.depots.Rangpur)}</td>
                    <td class="text-end stock-value">${formatNumber(product.depots.Chattagram)}</td>
                    <td class="text-end">
                        <strong class="text-primary">${formatNumber(product.totalUnits)}</strong>
                        ${product.factoryFG ? `<br><small class="text-muted">Factory: ${formatNumber(product.factoryFG)}</small>` : ''}
                    </td>
                    <td class="text-center">
                        ${product.totalCartons ? `<strong>${formatNumber(product.totalCartons)}</strong>` : '0'}
                        ${product.unitPerCarton > 1 ? `<br><small class="text-muted">@${product.unitPerCarton}u</small>` : ''}
                    </td>
                    <td>${statusBadge}</td>
                    <td>
                        <div class="btn-group btn-group-sm">
                            <button class="btn btn-outline-primary" onclick="viewProductDetails('${product.name.replace(/'/g, "\\'")}')" title="View Details">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="btn btn-outline-info" onclick="showCartonDetails('${product.name.replace(/'/g, "\\'")}')" title="Carton Details">
                                <i class="fas fa-box"></i>
                            </button>
                        </div>
                    </td>
                `;
                
                tbody.appendChild(row);
            });
        }

        function createDepotChart(data) {
            const ctx = document.getElementById('depotChart').getContext('2d');
            
            // Destroy existing chart if it exists
            if (depotChart) {
                depotChart.destroy();
            }
            
            // Calculate depot totals
            const depotTotals = {};
            const depotNames = ['Dhaka', 'Jhenaidah', 'Bogra', 'Rangpur', 'Chattagram'];
            depotNames.forEach(depot => {
                depotTotals[depot] = data.products.reduce((sum, product) => 
                    sum + (product.depots[depot] || 0), 0);
            });
            
            // Create depot summary
            const depotSummary = document.getElementById('depotSummary');
            let summaryHTML = '';
            
            const colors = ['#3498db', '#2ecc71', '#e74c3c', '#f39c12', '#9b59b6'];
            Object.entries(depotTotals).forEach(([depot, total], index) => {
                const color = colors[index % colors.length];
                const percentage = (total / data.totalUnits * 100).toFixed(1);
                
                summaryHTML += `
                    <div class="mb-3">
                        <div class="d-flex justify-content-between align-items-center mb-1">
                            <div>
                                <span class="depot-indicator" style="background-color: ${color}"></span>
                                ${depot}
                            </div>
                            <div>
                                <strong>${formatNumber(total)}</strong>
                                <small class="text-muted ms-2">${percentage}%</small>
                            </div>
                        </div>
                        <div class="progress" style="height: 8px;">
                            <div class="progress-bar" style="width: ${percentage}%; background-color: ${color}"></div>
                        </div>
                    </div>
                `;
            });
            
            depotSummary.innerHTML = summaryHTML;
            
            // Create chart
            depotChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: Object.keys(depotTotals),
                    datasets: [{
                        label: 'Stock Quantity',
                        data: Object.values(depotTotals),
                        backgroundColor: colors.map(c => c.replace(')', ', 0.7)').replace('rgb', 'rgba')),
                        borderColor: colors,
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { display: false },
                        title: {
                            display: true,
                            text: 'Stock Distribution Across Depots'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Quantity (Units)'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Depots'
                            }
                        }
                    }
                }
            });
        }

        function checkLowStock(products) {
            const lowStockProducts = products.filter(p => p.status === 'low');
            
            if (lowStockProducts.length === 0) {
                lowStockAlert.classList.add('d-none');
                return;
            }
            
            lowStockAlert.classList.remove('d-none');
            const lowStockList = document.getElementById('lowStockList');
            
            let alertHTML = `
                <div class="alert alert-warning mb-3">
                    <i class="fas fa-exclamation-circle me-2"></i>
                    <strong>${lowStockProducts.length} product(s) have low stock levels</strong>
                </div>
                <div class="table-responsive">
                    <table class="table table-sm">
                        <thead>
                            <tr class="table-warning">
                                <th>Product</th>
                                <th>Portfolio</th>
                                <th>Total Units</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            lowStockProducts.forEach(product => {
                alertHTML += `
                    <tr>
                        <td><strong>${product.name}</strong></td>
                        <td>${product.portfolio || '-'}</td>
                        <td class="text-end"><span class="badge bg-danger">${formatNumber(product.totalUnits)} units</span></td>
                        <td><span class="low-stock">Low Stock</span></td>
                    </tr>
                `;
            });
            
            alertHTML += `
                        </tbody>
                    </table>
                </div>
            `;
            lowStockList.innerHTML = alertHTML;
        }

        function filterStock(type, value) {
            if (!currentData) return;
            
            if (type === 'all') {
                filteredProducts = [...currentData.products];
            } else if (type === 'low') {
                filteredProducts = currentData.products.filter(p => p.status === 'low');
            } else if (type === 'category' && value) {
                filteredProducts = currentData.products.filter(p => p.portfolio === value);
            }
            
            populateProductTable(filteredProducts);
        }

        function searchProducts() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase().trim();
            
            if (!searchTerm) {
                filteredProducts = [...currentData.products];
            } else {
                filteredProducts = currentData.products.filter(product => 
                    product.name.toLowerCase().includes(searchTerm) ||
                    (product.portfolio && product.portfolio.toLowerCase().includes(searchTerm)) ||
                    (product.packSize && product.packSize.toString().toLowerCase().includes(searchTerm))
                );
            }
            
            populateProductTable(filteredProducts);
        }

        function viewProductDetails(productName) {
            const product = currentData.products.find(p => p.name === productName);
            if (!product) return;
            
            document.getElementById('productModalTitle').textContent = product.name;
            
            // Create product details HTML
            const detailsHTML = `
                <div class="row">
                    <div class="col-md-6">
                        <table class="table table-sm">
                            <tr>
                                <th style="width: 40%">Product Name:</th>
                                <td>${product.name}</td>
                            </tr>
                            <tr>
                                <th>Pack Size:</th>
                                <td>${product.packSize || 'N/A'}</td>
                            </tr>
                            <tr>
                                <th>Portfolio:</th>
                                <td>${product.portfolio || '-'}</td>
                            </tr>
                            <tr>
                                <th>Stock Status:</th>
                                <td>${getStockStatusText(product.status)}</td>
                            </tr>
                            <tr>
                                <th>Total Units:</th>
                                <td><strong class="text-primary">${formatNumber(product.totalUnits)}</strong></td>
                            </tr>
                            <tr>
                                <th>Factory FG:</th>
                                <td>${formatNumber(product.factoryFG)}</td>
                            </tr>
                            <tr>
                                <th>Unit per Carton:</th>
                                <td>${product.unitPerCarton || 'N/A'}</td>
                            </tr>
                            <tr>
                                <th>Total Cartons:</th>
                                <td><strong class="text-info">${formatNumber(product.totalCartons)}</strong></td>
                            </tr>
                        </table>
                    </div>
                    <div class="col-md-6">
                        <h6>Unit Distribution:</h6>
                        <div style="height: 250px;">
                            <canvas id="productChart"></canvas>
                        </div>
                    </div>
                </div>
                
                <div class="mt-4">
                    <h6>Stock Details by Depot:</h6>
                    <div class="row">
            `;
            
            // Add depot cards
            const depots = ['Dhaka', 'Jhenaidah', 'Bogra', 'Rangpur', 'Chattagram'];
            depots.forEach(depot => {
                const quantity = product.depots[depot] || 0;
                detailsHTML += `
                    <div class="col-md-4 col-6 mb-3">
                        <div class="card">
                            <div class="card-body text-center py-3">
                                <div class="text-muted small">${depot}</div>
                                <div class="h4 mb-1">${formatNumber(quantity)}</div>
                                <div class="text-muted small">units</div>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            // Add Factory FG card
            detailsHTML += `
                    <div class="col-md-4 col-6 mb-3">
                        <div class="card bg-light">
                            <div class="card-body text-center py-3">
                                <div class="text-muted small">Factory FG</div>
                                <div class="h4 mb-1 text-primary">${formatNumber(product.factoryFG)}</div>
                                <div class="text-muted small">units</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            `;
            
            document.getElementById('productModalBody').innerHTML = detailsHTML;
            
            // Create product chart
            setTimeout(() => {
                const ctx = document.getElementById('productChart').getContext('2d');
                const chartData = {
                    labels: [...depots, 'Factory FG'],
                    datasets: [{
                        data: [...depots.map(d => product.depots[d] || 0), product.factoryFG],
                        backgroundColor: [
                            'rgba(52, 152, 219, 0.7)',
                            'rgba(46, 204, 113, 0.7)',
                            'rgba(231, 76, 60, 0.7)',
                            'rgba(243, 156, 18, 0.7)',
                            'rgba(155, 89, 182, 0.7)',
                            'rgba(241, 196, 15, 0.7)'
                        ]
                    }]
                };
                
                new Chart(ctx, {
                    type: 'doughnut',
                    data: chartData,
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom'
                            }
                        }
                    }
                });
            }, 100);
            
            // Show modal
            new bootstrap.Modal(document.getElementById('productModal')).show();
        }

        function showCartonDetails(productName) {
            const product = currentData.products.find(p => p.name === productName);
            if (!product) return;
            
            let cartonHTML = `
                <div class="row">
                    <div class="col-md-6">
                        <table class="table table-sm">
                            <tr>
                                <th style="width: 40%">Product:</th>
                                <td>${product.name}</td>
                            </tr>
                            <tr>
                                <th>Unit per Carton:</th>
                                <td><strong>${product.unitPerCarton || 'N/A'}</strong></td>
                            </tr>
                            <tr>
                                <th>Total Cartons:</th>
                                <td><strong class="text-primary">${formatNumber(product.totalCartons)}</strong></td>
                            </tr>
                            <tr>
                                <th>Total Units:</th>
                                <td>${formatNumber(product.totalUnits)}</td>
                            </tr>
                            <tr>
                                <th>Units per Carton:</th>
                                <td>${product.unitPerCarton || 'N/A'}</td>
                            </tr>
                        </table>
                    </div>
                    <div class="col-md-6">
                        <h6>Carton Distribution:</h6>
                        <table class="table table-sm table-bordered">
                            <thead>
                                <tr class="table-light">
                                    <th>Depot</th>
                                    <th class="text-end">Cartons</th>
                                    <th class="text-end">Units</th>
                                </tr>
                            </thead>
                            <tbody>
            `;
            
            // Add depot-wise carton details
            const depots = ['Dhaka', 'Jhenaidah', 'Bogra', 'Rangpur', 'Chattagram'];
            depots.forEach(depot => {
                const cartons = product.cartonDepots[depot] || 0;
                const units = product.depots[depot] || 0;
                cartonHTML += `
                    <tr>
                        <td>${depot}</td>
                        <td class="text-end">${formatNumber(cartons)}</td>
                        <td class="text-end">${formatNumber(units)}</td>
                    </tr>
                `;
            });
            
            // Add factory FG
            if (product.factoryFGCartons > 0) {
                cartonHTML += `
                    <tr class="table-info">
                        <td><strong>Factory FG</strong></td>
                        <td class="text-end"><strong>${formatNumber(product.factoryFGCartons)}</strong></td>
                        <td class="text-end"><strong>${formatNumber(product.factoryFG)}</strong></td>
                    </tr>
                `;
            }
            
            cartonHTML += `
                            </tbody>
                            <tfoot>
                                <tr class="table-secondary">
                                    <td><strong>Total</strong></td>
                                    <td class="text-end"><strong class="text-primary">${formatNumber(product.totalCartons)}</strong></td>
                                    <td class="text-end"><strong class="text-success">${formatNumber(product.totalUnits)}</strong></td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>
                
                <div class="mt-4">
                    <h6>Conversion Summary:</h6>
                    <div class="row">
                        <div class="col-md-4">
                            <div class="card">
                                <div class="card-body text-center">
                                    <div class="text-muted">Units per Carton</div>
                                    <h2 class="mt-2">${product.unitPerCarton || 'N/A'}</h2>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card">
                                <div class="card-body text-center">
                                    <div class="text-muted">Total Cartons</div>
                                    <h2 class="mt-2 text-primary">${formatNumber(product.totalCartons)}</h2>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card">
                                <div class="card-body text-center">
                                    <div class="text-muted">Total Units</div>
                                    <h2 class="mt-2 text-success">${formatNumber(product.totalUnits)}</h2>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('productModalTitle').textContent = `${product.name} - Carton Details`;
            document.getElementById('productModalBody').innerHTML = cartonHTML;
            
            new bootstrap.Modal(document.getElementById('productModal')).show();
        }

        function getStockStatusText(status) {
            switch(status) {
                case 'low': return '<span class="badge bg-danger">Low Stock</span>';
                case 'medium': return '<span class="badge bg-warning">Medium Stock</span>';
                case 'high': return '<span class="badge bg-success">High Stock</span>';
                default: return status;
            }
        }

        function exportToExcel() {
            if (!currentData || !filteredProducts.length) {
                alert('No data to export');
                return;
            }
            
            // Prepare data for export
            const exportData = [];
            
            // Add headers
            exportData.push([
                'No.', 'Product Name', 'Portfolio', 'Pack Size',
                'Dhaka', 'Jhenaidah', 'Bogra', 'Rangpur', 'Chattagram', 'Factory FG',
                'Total Units', 'Unit/Carton', 'Total Cartons', 'Status'
            ]);
            
            // Add product data
            filteredProducts.forEach((product, index) => {
                exportData.push([
                    index + 1,
                    product.name,
                    product.portfolio || '',
                    product.packSize || '',
                    product.depots.Dhaka || 0,
                    product.depots.Jhenaidah || 0,
                    product.depots.Bogra || 0,
                    product.depots.Rangpur || 0,
                    product.depots.Chattagram || 0,
                    product.factoryFG || 0,
                    product.totalUnits,
                    product.unitPerCarton || 0,
                    product.totalCartons || 0,
                    product.status.toUpperCase()
                ]);
            });
            
            // Create worksheet
            const ws = XLSX.utils.aoa_to_sheet(exportData);
            
            // Create workbook
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Stock Summary');
            
            // Generate filename
            const dateStr = new Date().toISOString().slice(0, 10);
            const sheetName = currentData.sheetName || 'stock';
            const filename = `Surovi_Stock_${sheetName}_${dateStr}.xlsx`;
            
            // Download file
            XLSX.writeFile(wb, filename);
        }

        // Initialize search functionality
        document.getElementById('searchInput').addEventListener('keyup', function(e) {
            if (e.key === 'Enter') {
                searchProducts();
            }
        });

        // Initialize on page load
        window.addEventListener('DOMContentLoaded', () => {
            console.log('Surovi Agro Industries Stock Dashboard v2.0 ready.');
            console.log('Upload your Excel file to begin analysis.');
        });
    </script>
</body>
</html>
